<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gesti√≥n de trabajos en escaleras port√°tiles y fijas ‚Äî Simulador</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0f1a; --panel:#0f1726; --card:#121c2f; --muted:#9fb0c3; --text:#eaf2ff;
    --stroke:#22324b; --brand1:#2dd4bf; --brand2:#3b82f6; --ok:#22c55e; --bad:#ef4444; --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:
    radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.18), transparent 60%),
    radial-gradient(900px 500px at 110% 10%, rgba(45,212,191,.15), transparent 55%),
    var(--bg); color:var(--text); line-height:1.6}
  .wrap{max-width:1100px;margin:0 auto;padding:1rem 1.25rem 2rem}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
    background:linear-gradient(180deg, rgba(6,10,18,.75), rgba(6,10,18,.3));
    border-bottom:1px solid rgba(147,197,253,.12)}
  .top{display:flex;justify-content:space-between;align-items:center;gap:1rem;
    background:linear-gradient(180deg, rgba(18,28,47,.7), rgba(18,28,47,.3));
    border:1px solid var(--stroke); padding:.9rem 1rem; border-radius:14px}
  .progressbar{width:100%;height:8px;background:#0c1526;border-radius:999px;overflow:hidden}
  .progressbar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand1),var(--brand2))}
  .hud{display:flex;gap:1rem;color:#cfe2ff}
  .pill{background:#10213a;border:1px solid #2a4269;border-radius:999px;padding:.2rem .6rem;font-size:.85rem}
  .card{margin-top:1rem;background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:1.1rem; box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .title{margin:.2rem 0 .1rem;font-size:clamp(1.2rem,2.6vw,1.6rem);font-weight:800}
  .subtitle{margin:0 0 .8rem;color:var(--muted)}
  .options{display:grid;gap:.6rem}
  .opt{display:flex;gap:.6rem;align-items:flex-start;padding:.7rem .8rem;background:#0e1a2c;border:1px solid #20324f;border-radius:12px;cursor:pointer}
  .opt:hover{border-color:#3a5e90;background:#10233e}
  .opt input{margin-top:.1rem}
  .actions{display:flex;gap:.6rem;margin-top:1rem;flex-wrap:wrap}
  .btn{border:none;border-radius:12px;padding:.6rem .95rem;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#081018}
  .btn.secondary{background:#12233e;color:#cae0ff;border:1px solid #2a4269}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .feedback{margin-top:.9rem;border-left:4px solid #2a4269;background:#0f1c30;border-radius:10px;padding:.65rem .8rem;display:none}
  .feedback.ok{border-left-color:var(--ok)} .feedback.bad{border-left-color:var(--bad)}
  video{display:none;width:100%;max-height:360px;border-radius:12px;margin-top:.6rem;background:#000}
  .results{display:none;margin-top:1rem;background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:1.1rem}
  .results h2{margin:.2rem 0 .6rem;font-size:1.4rem}
  .grid2{display:grid;gap:.6rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .metric{background:#0e1a2c;border:1px solid #20324f;border-radius:12px;padding:.8rem}
  .metric .big{font-size:1.6rem;font-weight:800}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="display:flex;gap:.6rem;align-items:center;color:#cfe2ff">
          <strong id="qCounter">Pregunta 1/16</strong>
          <span class="pill" id="scorePill">Puntaje: 0</span>
          <span class="pill" id="skipsPill">Saltadas: 0</span>
        </div>
        <div class="progressbar" aria-label="Progreso"><span id="progressFill"></span></div>
      </div>
      <div class="hud"><span class="pill">M√≥dulo: Escaleras</span></div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="qCard" aria-live="polite">
    <h2 class="title" id="qTitle">T√≠tulo</h2>
    <p class="subtitle" id="qSubtitle">Enunciado</p>
    <form class="options" id="optForm"></form>
    <div class="actions">
      <button class="btn secondary" id="skipBtn" type="button">Saltar</button>
      <button class="btn primary" id="nextBtn" type="button">Siguiente</button>
    </div>
    <div id="feedback" class="feedback"></div>
    <video id="qVideo" controls preload="metadata"></video>
  </section>

  <section class="results" id="results">
    <h2>Resultados del m√≥dulo</h2>
    <div class="grid2">
      <div class="metric"><div>Respuestas correctas</div><div class="big" id="mCorrect">0</div></div>
      <div class="metric"><div>Respuestas incorrectas</div><div class="big" id="mWrong">0</div></div>
      <div class="metric"><div>Preguntas saltadas</div><div class="big" id="mSkipped">0</div></div>
      <div class="metric"><div>% de capacitaci√≥n</div><div class="big" id="mPercent">0%</div></div>
    </div>
    <p style="color:var(--muted);margin-top:.8rem" id="mHint"></p>

    <!-- FORMULARIO PARA GUARDAR NOMBRE -->
    <div id="formNombre" style="margin-top:1.5rem;padding:1rem;background:#0e1a2c;border:1px solid #20324f;border-radius:12px;">
      <label for="nombreUsuario" style="display:block;margin-bottom:.5rem;font-weight:600;color:#eaf2ff;">
        üíæ Ingresa tu nombre para guardar tu resultado:
      </label>
      <input 
        type="text" 
        id="nombreUsuario" 
        placeholder="Tu nombre completo"
        maxlength="100"
        style="width:100%;padding:.6rem;border-radius:8px;border:1px solid #2a4269;background:#0b1328;color:#eaf2ff;font-size:1rem;margin-bottom:.7rem;"
      />
      <button 
        onclick="guardarResultadoSupabase()" 
        class="btn primary"
        style="width:100%;"
      >
        üíæ Guardar Resultado
      </button>
    </div>

    <!-- MENSAJE DE CONFIRMACI√ìN -->
    <div id="mensajeGuardado" style="display:none;margin-top:1rem;padding:.8rem;background:#10b981;color:#fff;border-radius:8px;text-align:center;font-weight:700;"></div>

    <div class="actions" style="margin-top:1rem">
      <button class="btn primary" type="button" id="restartBtn">Reiniciar m√≥dulo</button>
      <a class="btn secondary" href="empleados.html">Volver a Empleados</a>
    </div>
  </section>
</main>

<script>
  function shuffle(a){ const r=a.slice(); for(let i=r.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];} return r; }

  const questions = [
    {
      title:"Estabilidad de la escalera",
      subtitle:"¬øQu√© medida es esencial para garantizar la estabilidad de una escalera port√°til antes de usarla?",
      options:[
        {text:"Colocarla en una superficie resbaladiza para asegurar su firmeza", feedbackIncorrect:"Superficies resbaladizas incrementan el riesgo de ca√≠da."},
        {text:"Comprobar que la base de la escalera est√© nivelada y asegurada", correct:true, feedbackCorrect:"Base nivelada y fija evita deslizamientos o vuelcos."},
        {text:"Solo colocar la escalera sobre una superficie plana, sin preocupar por la estabilidad", feedbackIncorrect:"La estabilidad depende de m√°s factores que la planitud."},
        {text:"Asegurar que la escalera est√© a la sombra para evitar el calor", feedbackIncorrect:"La prioridad es la estabilidad, no la sombra."}
      ],
      media:{ok:"escalera1.mp4", bad:"escalera2.mp4"}
    },
    {
      title:"Zapatas antideslizantes",
      subtitle:"¬øPor qu√© es importante que una escalera tenga zapatas antideslizantes?",
      options:[
        {text:"Para mantener la escalera limpia", feedbackIncorrect:"No es su funci√≥n principal."},
        {text:"Para prevenir que la escalera se deslice sobre superficies mojadas o resbaladizas", correct:true, feedbackCorrect:"Proporcionan tracci√≥n y estabilidad."},
        {text:"Para hacer que la escalera sea m√°s ligera", feedbackIncorrect:"No afectan el peso significativamente."},
        {text:"Para que la escalera sea m√°s f√°cil de transportar", feedbackIncorrect:"Su objetivo es seguridad, no transporte."}
      ],
      media:{ok:"escalera3.mp4", bad:"escalera4.mp4"}
    },
    {
      title:"Zapata da√±ada",
      subtitle:"¬øQu√© debe hacer un trabajador si la escalera port√°til que est√° usando tiene una zapata da√±ada?",
      options:[
        {text:"Seguir trabajando con la escalera y ajustarla seg√∫n sea necesario", feedbackIncorrect:"Trabajar con da√±o aumenta el riesgo."},
        {text:"Informar al supervisor y suspender el trabajo hasta que la zapata sea reparada o reemplazada", correct:true, feedbackCorrect:"Reparar/reemplazar antes de continuar."},
        {text:"Colocar la escalera sobre una superficie rugosa para contrarrestar el da√±o", feedbackIncorrect:"No compensa el defecto."},
        {text:"Usar la escalera con mayor precauci√≥n, ya que el da√±o es m√≠nimo", feedbackIncorrect:"No se asumen riesgos con defectos."}
      ],
      media:{ok:"escalera5.mp4", bad:"escalera6.mp4"}
    },
    {
      title:"Funci√≥n del arn√©s",
      subtitle:"¬øCu√°l es la funci√≥n del arn√©s de seguridad cuando se trabaja en una escalera a gran altura?",
      options:[
        {text:"Mejorar la comodidad durante el trabajo", feedbackIncorrect:"Su fin no es confort."},
        {text:"Proteger al trabajador de ca√≠das asegur√°ndolo a un punto seguro", correct:true, feedbackCorrect:"Evita ca√≠das graves asegurando al trabajador."},
        {text:"Evitar que el trabajador se deslice hacia abajo durante el trabajo", feedbackIncorrect:"Su prop√≥sito es antica√≠das, no antideslizamiento."},
        {text:"Reducir el peso del equipo del trabajador", feedbackIncorrect:"No reduce peso."}
      ],
      media:{ok:"escalera7.mp4", bad:"escalera8.mp4"}
    },
    {
      title:"EPP esencial en altura",
      subtitle:"¬øQu√© equipo de protecci√≥n personal es esencial para trabajar en una escalera a gran altura?",
      options:[
        {text:"Solo botas antideslizantes", feedbackIncorrect:"Se requieren medidas adicionales."},
        {text:"Casco de seguridad, guantes de agarre y, cuando es necesario, arn√©s de seguridad", correct:true, feedbackCorrect:"Conjunto de protecci√≥n completa."},
        {text:"Solo guantes resistentes", feedbackIncorrect:"Insuficiente sin casco/arn√©s."},
        {text:"Solo gafas de protecci√≥n", feedbackIncorrect:"No previenen ca√≠das."}
      ],
      media:{ok:"escalera10.mp4", bad:"escalera10.mp4"}
    },
    {
      title:"Ajuste del arn√©s",
      subtitle:"¬øQu√© debe hacer un trabajador si nota que el arn√©s de seguridad est√° mal ajustado antes de usarlo en la escalera?",
      options:[
        {text:"Continuar trabajando, ya que no importa si est√° un poco flojo", feedbackIncorrect:"Un arn√©s flojo no protege."},
        {text:"Ajustarlo correctamente o pedir a otro trabajador que lo ajuste", correct:true, feedbackCorrect:"Debe quedar firme y correcto."},
        {text:"Ignorar el problema, ya que el arn√©s no es necesario", feedbackIncorrect:"Es esencial seg√∫n el riesgo."},
        {text:"Usarlo tal como est√°, ya que el ajuste no afecta la seguridad", feedbackIncorrect:"El ajuste es cr√≠tico."}
      ],
      media:{ok:"escalera11.mp4", bad:"escalera12.mp4"}
    },
    {
      title:"√Ångulo adecuado",
      subtitle:"¬øQu√© debe hacer un trabajador si la escalera est√° inclinada en un √°ngulo inadecuado para el trabajo?",
      options:[
        {text:"Continuar con el trabajo, ya que el √°ngulo no es importante", feedbackIncorrect:"El √°ngulo es clave para la estabilidad."},
        {text:"Ajustar el √°ngulo de la escalera o cambiar de lugar la escalera hasta encontrar un √°ngulo m√°s seguro", correct:true, feedbackCorrect:"Ajustar o reubicar hasta lograr el √°ngulo seguro."},
        {text:"Subir solo con precauci√≥n", feedbackIncorrect:"El riesgo se mantiene alto."},
        {text:"Pedirle a otro trabajador que se suba primero para probar la estabilidad", feedbackIncorrect:"No es un m√©todo seguro."}
      ],
      media:{ok:"escalera13.mp4", bad:"escalera14.mp4"}
    },
    {
      title:"Pelda√±os da√±ados",
      subtitle:"¬øQu√© acci√≥n debe tomar un trabajador si encuentra que los pelda√±os de la escalera est√°n da√±ados antes de subir?",
      options:[
        {text:"Ignorar el da√±o y continuar trabajando", feedbackIncorrect:"Puede resultar en accidente grave."},
        {text:"Informar al supervisor y suspender el trabajo hasta que la escalera sea reparada o reemplazada", correct:true, feedbackCorrect:"Reparaci√≥n/reemplazo antes de usar."},
        {text:"Usar la escalera con m√°s precauci√≥n", feedbackIncorrect:"No se acepta usarla da√±ada."},
        {text:"Reparar los pelda√±os temporalmente y seguir", feedbackIncorrect:"Arreglo temporal no garantiza seguridad."}
      ],
      media:{ok:"escalera15.mp4", bad:"escalera16.mp4"}
    },
    {
      title:"Casco en altura",
      subtitle:"¬øQu√© puede suceder si un trabajador no usa un casco de seguridad mientras trabaja en una escalera a gran altura?",
      options:[
        {text:"Nada, ya que el casco solo es necesario en trabajos sin altura", feedbackIncorrect:"El casco es esencial tambi√©n en altura."},
        {text:"El trabajador puede sufrir graves lesiones en la cabeza si ocurre una ca√≠da o si algo cae sobre √©l", correct:true, feedbackCorrect:"Protege de impactos y objetos que caen."},
        {text:"El casco solo protege de golpes menores", feedbackIncorrect:"Tambi√©n mitiga lesiones graves."},
        {text:"No necesita casco si usa arn√©s correctamente", feedbackIncorrect:"Son protecciones complementarias."}
      ],
      media:{ok:"escalera18.mp4", bad:"escalera18.mp4"}
    },
    {
      title:"Casco se cae",
      subtitle:"¬øQu√© debe hacer un trabajador si el casco de seguridad que usa se cae al suelo durante el trabajo?",
      options:[
        {text:"Continuar trabajando sin el casco", feedbackIncorrect:"Extremadamente riesgoso."},
        {text:"Revisar el casco por posibles da√±os y, si es necesario, reemplazarlo", correct:true, feedbackCorrect:"Inspeccionar y reemplazar si hay duda."},
        {text:"Colocar el casco de vuelta y seguir sin m√°s", feedbackIncorrect:"Una ca√≠da puede comprometer su integridad."},
        {text:"Usar otro casco solo si el supervisor lo indica", feedbackIncorrect:"Debe hacerse de inmediato por seguridad."}
      ],
      media:{ok:"escalera19.mp4", bad:"escalera20.mp4"}
    },
    {
      title:"Riesgo de ca√≠da de objetos",
      subtitle:"¬øQu√© medidas de seguridad deben tomarse si se est√° trabajando con una escalera cerca de un √°rea con riesgos de ca√≠da de objetos?",
      options:[
        {text:"Ignorar el riesgo, ya que la escalera est√° fija", feedbackIncorrect:"Puede causar accidentes graves."},
        {text:"Usar un casco de seguridad y asegurarse de que la zona est√© despejada de objetos ca√≠dos", correct:true, feedbackCorrect:"Casco + zona despejada."},
        {text:"Continuar trabajando solo con guantes de protecci√≥n", feedbackIncorrect:"Los guantes no protegen la cabeza."},
        {text:"Dejar que otros trabajadores manejen los objetos peligrosos", feedbackIncorrect:"Todos deben seguir medidas adecuadas."}
      ],
      media:{ok:"escalera21.mp4", bad:"escalera22.mp4"}
    },
    {
      title:"EPP clave por ca√≠da de objetos",
      subtitle:"¬øQu√© equipo es esencial cuando se trabaja en una escalera y el √°rea tiene riesgo de ca√≠da de objetos?",
      options:[
        {text:"Casco de seguridad", correct:true, feedbackCorrect:"Protege la cabeza de objetos que caen."},
        {text:"Solo guantes resistentes", feedbackIncorrect:"No protegen ante impactos en la cabeza."},
        {text:"Botas antideslizantes", feedbackIncorrect:"Importantes, pero no reemplazan el casco."},
        {text:"Solo gafas de protecci√≥n", feedbackIncorrect:"Las gafas no sustituyen el casco."}
      ],
      media:{ok:"escalera23.mp4", bad:"escalera24.mp4"}
    },
    {
      title:"Acci√≥n ante accidente de ca√≠da desde altura",
      subtitle:"¬øCu√°l es la primera acci√≥n que debe tomar un obrero al presenciar un accidente de ca√≠da desde altura?",
      options:[
        {text:"Llamar inmediatamente a los servicios de emergencia.", correct:true, feedbackCorrect:"La primera acci√≥n debe ser alertar a los profesionales para una atenci√≥n r√°pida y segura."},
        {text:"Intentar mover a la persona herida sin esperar ayuda.", feedbackIncorrect:"Esto puede agravar lesiones, especialmente de columna o fracturas."},
        {text:"Ignorar la situaci√≥n y continuar trabajando.", feedbackIncorrect:"No intervenir pone en riesgo al afectado y al resto del equipo."},
        {text:"Evacuar r√°pidamente el √°rea para evitar m√°s accidentes.", feedbackIncorrect:"Primero hay que activar el protocolo de emergencias antes de evacuar."}
      ],
      media:{ok:"andamiop1x30.mp4", bad:"andamiop1x31.mp4"}
    },
    {
      title:"Acci√≥n incorrecta tras una ca√≠da",
      subtitle:"¬øQu√© acci√≥n es incorrecta cuando un obrero observa a un compa√±ero que ha ca√≠do desde una altura?",
      options:[
        {text:"Evaluar la situaci√≥n sin mover al herido y esperar ayuda profesional.", feedbackIncorrect:"Es correcto no mover al herido y esperar ayuda adecuada si no hay peligro inmediato."},
        {text:"Comenzar a administrar primeros auxilios sin formaci√≥n adecuada.", correct:true, feedbackCorrect:"Es un error ayudar sin capacitaci√≥n porque puede agravar lesiones graves."},
        {text:"Mantener la calma y dirigir a los dem√°s trabajadores para crear un espacio seguro.", feedbackIncorrect:"Fundamental para evitar nuevos riesgos y coordinar la ayuda."},
        {text:"Usar equipo de protecci√≥n personal adecuado antes de acercarse al herido.", feedbackIncorrect:"Siempre se debe usar EPP para auto-protecci√≥n y evitar contaminaciones."}
      ],
      media:{ok:"andamiop1x32.mp4", bad:"andamiop1x33.mp4"}
    },
    {
      title:"Valor personal y seguridad en altura",
      subtitle:"¬øPor qu√© es fundamental que un trabajador valore su vida mientras realiza tareas en alturas considerables?",
      options:[
        {text:"Porque su vida solo le pertenece a √©l", feedbackIncorrect:"La seguridad del trabajador tambi√©n afecta a quienes lo rodean."},
        {text:"Porque su seguridad tambi√©n afecta la vida de sus seres queridos y su futuro", correct:true, feedbackCorrect:"Protegerse significa cuidar tambi√©n a familia y entorno."},
        {text:"Porque su trabajo no tiene importancia si no valora su vida", feedbackIncorrect:"La seguridad pone en valor el trabajo y la vida de todos."},
        {text:"Porque el riesgo solo lo afecta a √©l, no a los dem√°s", feedbackIncorrect:"Un accidente impacta a muchas personas, no solo al trabajador."}
      ],
      media:{ok:"andamiop1x34.mp4", bad:"andamiop1x35.mp4"}
    },
    {
      title:"Valorar la vida trabajando en escaleras",
      subtitle:"¬øC√≥mo puede un trabajador asegurarse de que est√° valorando su vida mientras trabaja en escaleras?",
      options:[
        {text:"Solo cuid√°ndose a s√≠ mismo sin preocuparse por el equipo de seguridad", feedbackIncorrect:"El uso de EPP y cumplir los protocolos es esencial, no solo protegerse individualmente."},
        {text:"Usando todo el equipo de protecci√≥n personal (EPP) necesario y siguiendo los protocolos de seguridad", correct:true, feedbackCorrect:"Usar EPP y seguir procedimientos demuestra valoraci√≥n de la propia vida."},
        {text:"Trabajando lo m√°s r√°pido posible para terminar antes", feedbackIncorrect:"La prioridad debe ser la seguridad, no la velocidad."},
        {text:"Ignorando los riesgos si tiene experiencia en el trabajo", feedbackIncorrect:"La experiencia no elimina los riesgos."}
      ],
      media:{ok:"andamiop1x36.mp4", bad:"andamiop1x37.mp4"}
    }
  ];

  let idx=0, score=0, skipped=0, wrong=0, answeredCurrent=false;
  let shuffledOptions=[];

  const el = {
    qTitle: document.getElementById('qTitle'),
    qSubtitle: document.getElementById('qSubtitle'),
    form: document.getElementById('optForm'),
    next: document.getElementById('nextBtn'),
    skip: document.getElementById('skipBtn'),
    feedback: document.getElementById('feedback'),
    video: document.getElementById('qVideo'),
    qCounter: document.getElementById('qCounter'),
    scorePill: document.getElementById('scorePill'),
    skipsPill: document.getElementById('skipsPill'),
    progress: document.getElementById('progressFill'),
    results: document.getElementById('results'),
    qCard: document.getElementById('qCard'),
    mCorrect: document.getElementById('mCorrect'),
    mWrong: document.getElementById('mWrong'),
    mSkipped: document.getElementById('mSkipped'),
    mPercent: document.getElementById('mPercent'),
    mHint: document.getElementById('mHint'),
    restart: document.getElementById('restartBtn'),
  };

  function renderQuestion(){
    const q=questions[idx];
    answeredCurrent=false;
    el.video.pause(); el.video.currentTime=0; el.video.style.display='none';
    el.feedback.style.display='none'; el.feedback.textContent=''; el.feedback.className='feedback';
    el.qTitle.textContent=q.title;
    el.qSubtitle.textContent=q.subtitle||'';
    shuffledOptions = shuffle(q.options).map((o,i)=>({...o,_i:i}));
    el.form.innerHTML='';
    shuffledOptions.forEach((opt,i)=>{
      const lab=document.createElement('label');
      lab.className='opt';
      lab.innerHTML = `<input type="radio" name="opt" value="${i}"><div><strong>${String.fromCharCode(65+i)})</strong> ${opt.text}</div>`;
      el.form.appendChild(lab);
    });
    el.qCounter.textContent=`Pregunta ${idx+1}/${questions.length}`;
    el.progress.style.width=(idx/questions.length)*100 + '%';
    el.next.textContent='Siguiente';
    el.next.disabled=false;
  }

  function checkAndShow(){
    const sel = el.form.querySelector('input[type="radio"]:checked');
    if(!sel){ alert('Selecciona una opci√≥n o usa "Saltar".'); return false; }
    const choice = parseInt(sel.value,10);
    const chosen = shuffledOptions[choice];
    const isCorrect = !!chosen.correct;
    answeredCurrent = true;
    if(isCorrect){
      score++;
      el.feedback.classList.add('ok');
      el.feedback.textContent = chosen.feedbackCorrect || '¬°Correcto!';
      el.video.src = questions[idx].media.ok;
    }else{
      wrong++;
      el.feedback.classList.add('bad');
      el.feedback.textContent = chosen.feedbackIncorrect || 'Respuesta incorrecta.';
      el.video.src = questions[idx].media.bad;
    }
    el.feedback.style.display='block';
    el.video.style.display='block';
    el.video.play().catch(()=>{});
    el.form.querySelectorAll('input').forEach(i=>i.disabled=true);
    el.scorePill.textContent=`Puntaje: ${score}`;
    el.next.textContent = (idx===questions.length-1) ? 'Finalizar' : 'Siguiente';
    return true;
  }

  function skipQuestion(){ skipped++; el.skipsPill.textContent=`Saltadas: ${skipped}`; goNext(); }
  function goNext(){ if(idx<questions.length-1){ idx++; renderQuestion(); } else { showResults(); } }

  function showResults(){
    el.progress.style.width='100%';
    el.qCard.style.display='none';
    el.results.style.display='block';
    const total=questions.length, percent=Math.round((score/total)*100);
    el.mCorrect.textContent=score;
    el.mWrong.textContent=wrong;
    el.mSkipped.textContent=skipped;
    el.mPercent.textContent=percent+'%';
    let hint='Nivel de capacitaci√≥n: ';
    if(percent>=90) hint+='Excelente ‚úÖ';
    else if(percent>=75) hint+='Adecuado üëç';
    else if(percent>=60) hint+='B√°sico ‚ö†Ô∏è';
    else hint+='Insuficiente ‚ùå';
    el.mHint.textContent=hint;
  }

  el.next.addEventListener('click', ()=>{ if(!answeredCurrent){ if(!checkAndShow()) return; } else { goNext(); } });
  el.skip.addEventListener('click', skipQuestion);
  el.restart.addEventListener('click', ()=>{ 
    idx=0;score=0;skipped=0;wrong=0; 
    el.qCard.style.display='block'; 
    el.results.style.display='none'; 
    el.scorePill.textContent='Puntaje: 0'; 
    el.skipsPill.textContent='Saltadas: 0'; 
    resetearFormularioNombre();
    renderQuestion(); 
  });

  renderQuestion();
</script>

<!-- ==================== INTEGRACI√ìN SUPABASE ==================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://cjwocxsfcqllhzhlasuf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqd29jeHNmY3FsbGh6aGxhc3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTg1MDcsImV4cCI6MjA3Nzg3NDUwN30.B7HYB7nv7cE5sAfRjRTJSGYnRx18cubfroNyet1mt_A';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function obtenerNombreModulo() {
  const titulo = document.title.toLowerCase();
  
  if (titulo.includes('escaleras')) {
    return 'Escaleras';
  }
  if (titulo.includes('estructuras') || titulo.includes('encofrados')) {
    return 'Estructuras y Encofrados';
  }
  if (titulo.includes('supervisores')) {
    return 'Supervisores';
  }
  if (titulo.includes('andamios')) {
    return 'Andamios';
  }
  if (titulo.includes('cubiertas') || titulo.includes('techos')) {
    return 'Cubiertas y Techos';
  }
  if (titulo.includes('empleadores')) {
    return 'Empleadores';
  }
  
  return document.title;
}

async function guardarResultadoSupabase() {
  const nombre = document.getElementById('nombreUsuario').value.trim();
  if (!nombre) {
    alert('‚ö†Ô∏è Por favor ingresa tu nombre para guardar el resultado');
    return;
  }

  const btnGuardar = event.target;
  const textoOriginal = btnGuardar.textContent;
  btnGuardar.textContent = '‚è≥ Guardando...';
  btnGuardar.disabled = true;

  const modulo = obtenerNombreModulo();
  const correcto = parseInt(document.getElementById('mCorrect').textContent, 10);
  const incorrecto = parseInt(document.getElementById('mWrong').textContent, 10);
  const saltado = parseInt(document.getElementById('mSkipped').textContent, 10);
  const porcentaje = parseInt(document.getElementById('mPercent').textContent, 10);
  const puntaje = correcto * 100;

  console.log('Guardando:', { nombre, modulo, puntaje, correcto, incorrecto, saltado, porcentaje });

  const { data, error } = await supabase
    .from('resultados_test')
    .insert([{
      nombre: nombre,
      modulo: modulo,
      puntaje: puntaje,
      correcto: correcto,
      incorrecto: incorrecto,
      saltado: saltado,
      porcentaje: porcentaje
    }]);

  if (error) {
    console.error('Error:', error);
    alert('‚ùå Error al guardar: ' + error.message);
    btnGuardar.textContent = textoOriginal;
    btnGuardar.disabled = false;
  } else {
    document.getElementById('mensajeGuardado').style.display = 'block';
    document.getElementById('mensajeGuardado').textContent = '‚úÖ ¬°Resultado guardado correctamente! Puedes reiniciar para intentar de nuevo.';
    document.getElementById('formNombre').style.display = 'none';
  }
}

function resetearFormularioNombre() {
  document.getElementById('formNombre').style.display = 'block';
  document.getElementById('mensajeGuardado').style.display = 'none';
  document.getElementById('nombreUsuario').value = '';
}
</script>
</body>
</html>
